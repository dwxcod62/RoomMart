window.FrontEnd || (window.FrontEnd = {});
FrontEnd.BadReportProductsServices = function() {
    function r(n, i, r) {
        var f = t(),
            o = {
                productId: +n,
                saveTime: (new Date).toUTCString(),
                note: u(i, r)
            },
            e, s = f.filter(t => t.productId === n);
        return s.length > 0 ? (f = f.filter(t => t.productId !== n), localStorage && f && localStorage.setItem(BADREPORT_PRODUCTS, JSON.stringify(f)), e = {
            isReport: !1,
            BadReportProductsCount: f.length
        }) : (o.saveTime = (new Date).toUTCString(), f.unshift(o), localStorage && f && localStorage.setItem(BADREPORT_PRODUCTS, JSON.stringify(f)), e = {
            isReport: !0,
            BadReportProductsCount: f.length
        }), e
    }

    function t() {
        if (localStorage && (listProductSaveAsString = localStorage.getItem(BADREPORT_PRODUCTS), listProductSaveAsString)) {
            var n = JSON.parse(listProductSaveAsString);
            return n || []
        }
        return []
    }

    function u(n, t) {
        if (n.length == 0) return t;
        var i = n.split(";"),
            r = i.length;
        return r > 1 ? i[0] + ",..." : i[0] + (i.length > 1 ? ",..." : "")
    }

    function f(t, i, r, u) {
        var f = "";
        u ? (t.find(`.js__report-reason`).html(`Lý do: ${i}`), t.closest(`.js__card`).addClass(`${n.GetStyleClass("disabled")}`)) : (f = t.find(".product-link").html(), o(t.find(".contentRestore").children("div"), f, i, r), t.find(".wrap-plink").css("display", "none"), t.find(".contentRestore").removeAttr("style"))
    }

    function e(t, i, r) {
        var u = "";
        r ? i ? ($("#product-detail-wap .containerTitle").removeClass("badReport"), u = $("h1.h-sr-t").attr("data-title"), $("h1.h-sr-t").html(u), $("#btn_unreport").css("display", "none"), $("#btn_report").removeAttr("style")) : t.closest(`.js__card`).removeClass(`${n.GetStyleClass("disabled")}`) : i ? ($("#product-detail-web .pr-title").removeClass("badReport"), u = $("#product-detail-web .pr-title").attr("data-title"), $("#product-detail-web .pr-title").html(u), $(".js__bad-report-recur").hide(), $(".js__item-more-report").removeClass(`${n.GetStyleClass("off")}`), $(".js__bad-report").show()) : (t.parents(".contentRestore").css("display", "none"), t.parents(".contentRestore").siblings(".wrap-plink").removeAttr("style"))
    }

    function o(n, t, i, r) {
        var u, f;
        t = t.trim();
        t = t.replace(/<[^>]*>?/gm, "");
        t = t.replace(/\s+/g, " ");
        t = t.length > 40 ? t.substring(0, 40) + "..." : t;
        u = GetShowDurationTime(new Date(r)).toLowerCase().replace("lưu ", "báo xấu ");
        u = u.charAt(0).toUpperCase() + u.slice(1);
        f = `<strong>Tin đã bị ẩn: </strong>${t}</br>
                    <strong>Lý do: </strong>${i}</br>
                    <span>${u}</span>`;
        n.html(f)
    }

    function i(n, t) {
        var f = t.text(),
            i = f,
            u, r;
        if (i = i.trim(), i = i.replace(/\s+/g, " "), t.attr("data-title", i), n.outerHeight() < t.outerHeight()) {
            while (n.outerHeight() < t.outerHeight()) t.text(i = i.substr(0, i.length - 1));
            t.text(i = i.substr(0, i.length - 20));
            t.append("... (Tin đang bị ẩn)")
        } else t.append(" (Tin đang bị ẩn)");
        if (u = t.text(), r = u, n.outerHeight() < t.outerHeight()) {
            while (n.outerHeight() < t.outerHeight()) t.text(r = r.substr(0, r.length - 1));
            t.text(r = r.substr(0, r.length - 20));
            t.append("... (Tin đang bị ẩn)")
        }
    }
    BADREPORT_PRODUCTS = "BADREPORT_PRODUCTS";
    BADREPORT_PRODUCTS_SYNC_TIME = "BADREPORT_PRODUCTS_SYNC_TIME";
    var n = new CommonJS.Common;
    this.BadReportListProduct = function(n) {
        var i = t();
        $(`.js__card`).each(function() {
            var t = i.filter(n => n.productId === +$(this).attr("prid"));
            t.length && f($(this), t[0].note, t[0].saveTime, n)
        })
    };
    this.BadReportDetailsProduct = function(u) {
        var f = t(),
            o = u ? $("#btn_unreport") : $(".js__bad-report-recur");
        $(".js__bad-report").each(function() {
            var t = +window.dataLayer[0].ite;
            f.filter(n => n.productId === +t).length && (u ? ($("#product-detail-wap .containerTitle").addClass("badReport"), i($("#product-detail-wap .containerTitle"), $("#product-detail-wap .h-sr-t")), $("#btn_report").css("display", "none"), $("#btn_unreport").removeAttr("style")) : ($("#product-detail-wap .containerTitle").addClass("badReport"), i($("#product-detail-web .pr-title"), $("#product-detail-web .pr-title")), $(".js__bad-report").hide(), $(".js__bad-report-recur").show(), $(".js__item-more-report").addClass(`${n.GetStyleClass("off")}`)))
        });
        o.click(function() {
            var n = $(this),
                t = +window.dataLayer[0].ite,
                i = r(t, "", "");
            i.isReport || e(n, !0, u)
        })
    };
    this.BadReportOrUnBadReportProduct = function(n, t, i) {
        return new Promise(function(u) {
            u(r(n, t, i))
        })
    };
    this.GetBadReportProductsFromLocal = function() {
        return new Promise(function(n) {
            n(t())
        })
    };
    this.ProcessTitle = function(n, t) {
        i(n, t)
    }
};
window.FrontEnd || (window.FrontEnd = {});
FrontEnd.SearchingHistoriesServices = function(n) {
    function s() {
        var n = navigator.userAgent;
        return /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(n) ? "tablet" : /Mobile|iP(hone|od|ad)|Android|BlackBerry|IEMobile|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(n) ? "mobile" : "desktop"
    }

    function e() {
        var n = new Date;
        return n.toUTCString()
    }

    function r(n) {
        if (localStorage) {
            var i = JSON.stringify(n);
            localStorage.setItem(t, i)
        }
    }

    function o() {
        var i = [],
            n;
        return localStorage && (n = localStorage.getItem(t), n && (i = JSON.parse(n))), i.map((n, t) => (n.index = t, n.searchingInfos && n.searchingInfos.keywork && (n.searchingInfos.keywork = n.searchingInfos.keywork.replace(/[\u00A0-\u9999<>\&]/gim, function(n) {
            return "&#" + n.charCodeAt(0) + ";"
        })), n))
    }

    function h(i) {
        if (localStorage) {
            var f = localStorage.getItem(t),
                u;
            for (u = f ? JSON.parse(f) : [], u = u.filter(function(n) {
                    return JSON.stringify(n.searchingInfos) !== JSON.stringify(i)
                }), u.push({
                    searchingInfos: i,
                    platform: s(),
                    saveTime: e()
                }); u.length > (n.maxLength || 20);) u.shift();
            r(u)
        }
    }

    function u(n) {
        if (localStorage) {
            var u = localStorage.getItem(t),
                i;
            i = u ? JSON.parse(u) : [];
            i = i.filter(function(t, i) {
                return i != n
            });
            r(i)
        }
    }

    function c() {
        var n;
        if (localStorage && (n = localStorage.getItem(i), n)) return new Date(n)
    }

    function l() {
        localStorage && localStorage.setItem(i, e())
    }

    function a(n, t) {
        return Math.round(n.getTime() - t.getTime()) / 6e4
    }!n && document.querySelectorAll("[searching-histories-service-params]").length && (n = JSON.parse(document.querySelector("[searching-histories-service-params]").getAttribute("searching-histories-service-params")));
    var t = "SEARCHING_HISTORIES",
        i = "SEARCHING_HISTORIES_SYNC_TIME",
        f = document.querySelector("#staticDomain") ? document.querySelector("#staticDomain").getAttribute("data-msvrouter") : "";
    this.GetSearchingHistories = function() {
        return new Promise(function(n) {
            n(o())
        })
    };
    this.SyncSearchingHistories = function(t) {
        var i = c(),
            u;
        (i == null || i != null && a(new Date, i) >= n.syncTimeSearchingHistories) && (u = o(), t.userid && fetch(`${f}${n.syncSearchingHistoriesUrl}?userId=${t.userid}`, {
            method: "POST",
            headers: {
                Accept: "application/json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                searchingHistories: u
            })
        }).then(n => n.json()).then(function(n) {
            r(n)
        }), l())
    };
    this.AddSearchingHistory = function(n) {
        return new Promise(function(t) {
            h(n);
            t()
        })
    };
    this.RemoveSearchingHistory = function(t, i) {
        return new Promise(function(r) {
            if (i) {
                var e = 20;
                (function o() {
                    --e;
                    window.userServices ? window.userServices.getCurrentUserInfo(function(e) {
                        if (e) return cm.AjaxWrapperWithPromise({
                            type: "POST",
                            url: `${f}${n.removeSearchingHistoryUrl}?id=${i}`
                        }).then(function(n) {
                            n && u(t);
                            r(n)
                        });
                        u(t);
                        r(!0)
                    }) : e >= 0 && setTimeout(o, 100)
                })()
            } else u(t), r(!0)
        })
    };
    this.RemoveAllSearchingHistoiesInLocal = function() {
        localStorage && (localStorage.removeItem(t), localStorage.removeItem(i))
    }
};